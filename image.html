<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Image</title>
  <style>
    .block {margin: 10px 0;}
  </style>
</head>
<body>
  <div class="block">
    <input id="upload" type="file" accept="image/*">
  </div>
  <div class="action-btns">
    <div class="block">
      <button data-action="back">Back</button>
      <button data-action="save">Save</button>
    </div>
    <div class="block">
      <button data-action="rotateNegative90">-90°</button>
      <button data-action="rotate90">90°</button>
      <button data-action="rotate180">180°</button>
      <button data-action="hMirror">Mirror(H)</button>
      <button data-action="vMirror">Mirror(V)</button>
      <button data-action="scale50">50%</button>
      <button data-action="scale200">200%</button>
      <button data-action="gray">Gray</button>
      <button data-action="decreaseSaturation">Saturation-</button>
      <button data-action="increaseSaturation">Saturation+</button>
      <button data-action="decreaseLightness">Lightness-</button>
      <button data-action="increaseLightness">Lightness+</button>
      <button data-action="decreaseValue">Value-</button>
      <button data-action="increaseValue">Value+</button>
    </div>
  </div>
  <canvas class="block"></canvas>

  <script src="js/jquery.min.js"></script>
  <script src="js/tinycolor.js"></script>
  <script src="js/utils.js"></script>
  <script>
    const canvas = $('canvas').get(0)
    const ctx = canvas.getContext('2d')
    const history = []
    let fileName

    $('#upload').on('change', function (e) {
      const image = new Image()
      image.onload = function () {
        _adjustCanvasSize(this.width, this.height)
        ctx.drawImage(this, 0, 0)
        _saveToHistory()
      }
      image.src = URL.createObjectURL(this.files[0])
      fileName = this.files[0].name
    })

    $('.action-btns button').on('click', function () {
      const action = $(this).data('action')
      window[action] && window[action]()
    })

    function _adjustCanvasSize (width, height) {
      canvas.width = width
      canvas.height = height
      canvas.style.width = `${canvas.width / window.devicePixelRatio}px`
      canvas.style.height = `${canvas.height / window.devicePixelRatio}px`
    }

    function _getImageData (sx = 0, sy = 0, sw = canvas.width, sh = canvas.height) {
      return ctx.getImageData(sx, sy, sw, sh)
    }

    function _saveToHistory () {
      history.push(_getImageData())
    }

    function back () {
      if (history.length > 1) {
        history.pop()
        const imageData = history[history.length - 1]
        _adjustCanvasSize(imageData.width, imageData.height)
        ctx.putImageData(imageData, 0, 0)
      }
    }

    function save () {
      const link = document.createElement('a')
      let type = fileName.match(/\.[^\.]+$/)[0].slice(1)
      if (type === 'jpg') type = 'jpeg'
      link.href = canvas.toDataURL(`image/${type}`)
      link.download = fileName
      link.click()
    }

    function rotateNegative90 () {
      const distWidth = canvas.height
      const distHeight = canvas.width
      const {data} = _getImageData()
      const distImageData = ctx.createImageData(distWidth, distHeight)
      let distIndex = 0
      for (let i = canvas.width - 1; i >= 0; i--) {
        for (let j = 0; j < canvas.height; j++) {
          const index = (j * canvas.width + i) * 4
          distImageData.data[distIndex] = data[index]
          distImageData.data[distIndex + 1] = data[index + 1]
          distImageData.data[distIndex + 2] = data[index + 2]
          distImageData.data[distIndex + 3] = data[index + 3]
          distIndex += 4
        }
      }
      _adjustCanvasSize(distWidth, distHeight)
      ctx.putImageData(distImageData, 0, 0)
      _saveToHistory()
    }

    function rotate90 () {
      const distWidth = canvas.height
      const distHeight = canvas.width
      const {data} = _getImageData()
      const distImageData = ctx.createImageData(distWidth, distHeight)
      let distIndex = 0
      for (let i = 0; i < canvas.width; i++) {
        for (let j = canvas.height - 1; j >= 0; j--) {
          const index = (j * canvas.width + i) * 4
          distImageData.data[distIndex] = data[index]
          distImageData.data[distIndex + 1] = data[index + 1]
          distImageData.data[distIndex + 2] = data[index + 2]
          distImageData.data[distIndex + 3] = data[index + 3]
          distIndex += 4
        }
      }
      _adjustCanvasSize(distWidth, distHeight)
      ctx.putImageData(distImageData, 0, 0)
      _saveToHistory()
    }

    function rotate180 () {
      const distWidth = canvas.width
      const distHeight = canvas.height
      const {data} = _getImageData()
      const distImageData = ctx.createImageData(distWidth, distHeight)
      let distIndex = 0
      for (let j = canvas.height - 1; j >= 0; j--) {
        for (let i = canvas.width - 1; i >= 0; i--) {
          const index = (j * canvas.width + i) * 4
          distImageData.data[distIndex] = data[index]
          distImageData.data[distIndex + 1] = data[index + 1]
          distImageData.data[distIndex + 2] = data[index + 2]
          distImageData.data[distIndex + 3] = data[index + 3]
          distIndex += 4
        }
      }
      _adjustCanvasSize(distWidth, distHeight)
      ctx.putImageData(distImageData, 0, 0)
      _saveToHistory()
    }

    function hMirror () {
      const distWidth = canvas.width
      const distHeight = canvas.height
      const {data} = _getImageData()
      const distImageData = ctx.createImageData(distWidth, distHeight)
      let distIndex = 0
      for (let j = 0; j < canvas.height; j++) {
        for (let i = canvas.width - 1; i >= 0; i--) {
          const index = (j * canvas.width + i) * 4
          distImageData.data[distIndex] = data[index]
          distImageData.data[distIndex + 1] = data[index + 1]
          distImageData.data[distIndex + 2] = data[index + 2]
          distImageData.data[distIndex + 3] = data[index + 3]
          distIndex += 4
        }
      }
      _adjustCanvasSize(distWidth, distHeight)
      ctx.putImageData(distImageData, 0, 0)
      _saveToHistory()
    }

    function vMirror () {
      const distWidth = canvas.width
      const distHeight = canvas.height
      const {data} = _getImageData()
      const distImageData = ctx.createImageData(distWidth, distHeight)
      let distIndex = 0
      for (let j = canvas.height - 1; j >= 0; j--) {
        for (let i = 0; i < canvas.width; i++) {
          const index = (j * canvas.width + i) * 4
          distImageData.data[distIndex] = data[index]
          distImageData.data[distIndex + 1] = data[index + 1]
          distImageData.data[distIndex + 2] = data[index + 2]
          distImageData.data[distIndex + 3] = data[index + 3]
          distIndex += 4
        }
      }
      _adjustCanvasSize(distWidth, distHeight)
      ctx.putImageData(distImageData, 0, 0)
      _saveToHistory()
    }

    function scale50 () {
      const distWidth = Math.floor(canvas.width / 2)
      const distHeight = Math.floor(canvas.height / 2)
      const {data} = _getImageData()
      const distImageData = ctx.createImageData(distWidth, distHeight)
      let distIndex = 0
      for (let j = 0; j < canvas.height; j++) {
        for (let i = 0; i < canvas.width; i++) {
          if (j % 2 !== 0 && i % 2 !== 0) {
            const index = (j * canvas.width + i) * 4
            distImageData.data[distIndex] = data[index]
            distImageData.data[distIndex + 1] = data[index + 1]
            distImageData.data[distIndex + 2] = data[index + 2]
            distImageData.data[distIndex + 3] = data[index + 3]
            distIndex += 4
          }
        }
      }
      _adjustCanvasSize(distWidth, distHeight)
      ctx.putImageData(distImageData, 0, 0)
      _saveToHistory()
    }

    function scale200 () {
      const distWidth = canvas.width * 2
      const distHeight = canvas.height * 2
      const {data} = _getImageData()
      const distImageData = ctx.createImageData(distWidth, distHeight)
      let distIndex = 0
      for (let j = 0; j < canvas.height; j++) {
        for (let i = 0; i < canvas.width; i++) {
          const index = (j * canvas.width + i) * 4
          distImageData.data[distIndex] = data[index]
          distImageData.data[distIndex + 1] = data[index + 1]
          distImageData.data[distIndex + 2] = data[index + 2]
          distImageData.data[distIndex + 3] = data[index + 3]
          distImageData.data[distIndex + 4] = data[index]
          distImageData.data[distIndex + 5] = data[index + 1]
          distImageData.data[distIndex + 6] = data[index + 2]
          distImageData.data[distIndex + 7] = data[index + 3]
          distImageData.data[distWidth * 4 + distIndex] = data[index]
          distImageData.data[distWidth * 4 + distIndex + 1] = data[index + 1]
          distImageData.data[distWidth * 4 + distIndex + 2] = data[index + 2]
          distImageData.data[distWidth * 4 + distIndex + 3] = data[index + 3]
          distImageData.data[distWidth * 4 + distIndex + 4] = data[index]
          distImageData.data[distWidth * 4 + distIndex + 5] = data[index + 1]
          distImageData.data[distWidth * 4 + distIndex + 6] = data[index + 2]
          distImageData.data[distWidth * 4 + distIndex + 7] = data[index + 3]
          distIndex += 8
          if ((i + 1) % canvas.width === 0) {
            distIndex += distWidth * 4
          }
        }
      }
      _adjustCanvasSize(distWidth, distHeight)
      ctx.putImageData(distImageData, 0, 0)
      _saveToHistory()
    }

    function gray () {
      const imageData = _getImageData()
      const data = imageData.data
      for (let i = 0; i < data.length; i += 4) {
        //*/
        const ratio = {r: 0.3, g: 0.59, b: 0.11}
        // const ratio = {r: 1 / 3, g: 1 / 3, b: 1 / 3}
        const gray = ratio.r * data[i] + ratio.g * data[i + 1] + ratio.b * data[i + 2]
        /*/
        const gray = Math.max(data[i], data[i + 1], data[i + 2])
        // const gray = Math.min(data[i], data[i + 1], data[i + 2])
        //*/
        data[i] = data[i + 1] = data[i + 2] = gray
      }
      ctx.putImageData(imageData, 0, 0)
      _saveToHistory()
    }

    function decreaseSaturation () {
      const imageData = _getImageData()
      const data = imageData.data
      for (let i = 0; i < data.length; i += 4) {
        const color = tinycolor({
          r: data[i],
          g: data[i + 1],
          b: data[i + 2]
        })
        const hsl = color.toHsl()
        hsl.s -= hsl.s * 0.15
        const newColor = tinycolor(hsl)
        const newRgb = newColor.toRgb()
        data[i] = newRgb.r
        data[i + 1] = newRgb.g
        data[i + 2] = newRgb.b
      }
      ctx.putImageData(imageData, 0, 0)
      _saveToHistory()
    }

    function increaseSaturation () {
      const imageData = _getImageData()
      const data = imageData.data
      for (let i = 0; i < data.length; i += 4) {
        const color = tinycolor({
          r: data[i],
          g: data[i + 1],
          b: data[i + 2]
        })
        const hsl = color.toHsl()
        hsl.s += (1 - hsl.s) * 0.15
        const newColor = tinycolor(hsl)
        const newRgb = newColor.toRgb()
        data[i] = newRgb.r
        data[i + 1] = newRgb.g
        data[i + 2] = newRgb.b
      }
      ctx.putImageData(imageData, 0, 0)
      _saveToHistory()
    }

    function decreaseLightness () {
      const imageData = _getImageData()
      const data = imageData.data
      for (let i = 0; i < data.length; i += 4) {
        const color = tinycolor({
          r: data[i],
          g: data[i + 1],
          b: data[i + 2]
        })
        const hsl = color.toHsl()
        hsl.l -= hsl.l * 0.15
        const newColor = tinycolor(hsl)
        const newRgb = newColor.toRgb()
        data[i] = newRgb.r
        data[i + 1] = newRgb.g
        data[i + 2] = newRgb.b
      }
      ctx.putImageData(imageData, 0, 0)
      _saveToHistory()
    }

    function increaseLightness () {
      const imageData = _getImageData()
      const data = imageData.data
      for (let i = 0; i < data.length; i += 4) {
        const color = tinycolor({
          r: data[i],
          g: data[i + 1],
          b: data[i + 2],
        })
        const hsl = color.toHsl()
        hsl.l += (1 - hsl.l) * 0.15
        const newColor = tinycolor(hsl)
        const newRgb = newColor.toRgb()
        data[i] = newRgb.r
        data[i + 1] = newRgb.g
        data[i + 2] = newRgb.b
      }
      ctx.putImageData(imageData, 0, 0)
      _saveToHistory()
    }

    function decreaseValue () {
      const imageData = _getImageData()
      const data = imageData.data
      for (let i = 0; i < data.length; i += 4) {
        const color = tinycolor({
          r: data[i],
          g: data[i + 1],
          b: data[i + 2],
        })
        const hsv = color.toHsv()
        hsv.v -= hsv.v * 0.15
        const newColor = tinycolor(hsv)
        const newRgb = newColor.toRgb()
        data[i] = newRgb.r
        data[i + 1] = newRgb.g
        data[i + 2] = newRgb.b
      }
      ctx.putImageData(imageData, 0, 0)
      _saveToHistory()
    }

    function increaseValue () {
      const imageData = _getImageData()
      const data = imageData.data
      for (let i = 0; i < data.length; i += 4) {
        const color = tinycolor({
          r: data[i],
          g: data[i + 1],
          b: data[i + 2],
        })
        const hsv = color.toHsv()
        hsv.v += (1 - hsv.v) * 0.15
        const newColor = tinycolor(hsv)
        const newRgb = newColor.toRgb()
        data[i] = newRgb.r
        data[i + 1] = newRgb.g
        data[i + 2] = newRgb.b
      }
      ctx.putImageData(imageData, 0, 0)
      _saveToHistory()
    }
  </script>
</body>
</html>
